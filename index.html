<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stepdance Software Library: Stepdance Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Stepdance Software Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('index.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Stepdance Documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_doc_2readme"></a></p>
<hr  />
 <h1 class="doxsection"><a class="anchor" id="autotoc_md38"></a>
What is Stepdance?</h1>
<p>Stepdance is a framework for creative motion control. Stepdance is:</p>
<ul>
<li><b>Real-time</b>: Control motors with essentially zero latency using a variety of inputs such as potentiometers and encoders.</li>
<li><b>Modular</b>: Stepdance programs can be composed of software modules, and physical stepdance boards can be chained together.</li>
<li><b>Hybrid</b>: Blend real-time inputs and manipulation with traditional pre-planned approaches such as G-code. <hr  />
 </li>
</ul>
<h1 class="doxsection"><a class="anchor" id="autotoc_md39"></a>
Stepdance Hardware</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md40"></a>
Driver Module Board v1.0</h2>
<p><img src="module_driver.png" alt="" class="inline"/>    </p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md41"></a>
Stepper Drivers and Motor Interfaces</h3>
<p>This board is designed for <a href="https://pages.github.com/">BIGTREETECH TMC2209</a> driver modules. The sockets have the following pinouts, and microstepping is set by bridging the 2x2 male header pins as shown: <img src="stepper_driver_sockets.png" alt="" class="inline"/>    </p>
<p>Note that the +5V supply pin is additional to the pins on the TMC2209, and is for future expansion options. These sockets provide a flexible interface for a variety of outputs. For example, our servo stepper board accepts Step/Direction inputs and converts into a hobby servo output.</p>
<p><b>All driver socket logic connections (e.g. MS1/MS2, STEP, DIR, EN) are at 3.3V</b></p>
<p>Motors interface with the Stepdance driver module via a 4-pin motor header and a 3-pin limit switch header. <b>The limit switch input is at 5V</b> for compatibility with industrial proximity switches.</p>
<p>Motor interface header pinouts are as shown: <img src="motor_connectors.png" alt="" class="inline"/>    </p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md42"></a>
Encoders and Analog / Digital Inputs</h3>
<p>Two quadrature encoder inputs and six general-purpose IO (GPIO) ports are provided:</p>
<ul>
<li>ENC1 and ENC2 are <b>5V</b> quadrature inputs, and are compatible with standard optical encoders like those from US Digital or <a class="el" href="taiss.html">TAISS Optical Encoders</a>.</li>
<li>A1 thru A4 are <b>3.3V</b> <em>analog</em> and <em>digital</em> inputs, as well as digital outputs.</li>
<li>D1 and D2 are <b>3.3V</b> <em>digital</em> inputs and outputs.</li>
</ul>
<p>These are all Molex SL series connectors. Pinouts are as shown: <img src="input_connectors.png" alt="" class="inline"/>    </p>
<p>The A and B encoder inputs are pulled high thru 10k resistors, for compatibility with open-collector encoders like the TAISS modules.</p>
<p>A1-A4 and D1-D2 do <em>not</em> have external pullups, but internal pullups on the microcontroller can be enabled.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md43"></a>
QWIIC Connectors</h3>
<p>Two are provided. It is intended that QWIIC1 is for interfacing with a board-mounted display and knob, while QWIIC0 is for user accessories.</p>
<p>Note though that QWIIC1 exposes the TX4/RX4 serial port <b>(at 3.3V)</b>, which can be useful for interfacing with certain accessories. Pinout as shown: <img src="qwiic.png" alt="" class="inline"/>    </p>
<p><img src="sparkfun_qwiic.jpg" alt="" class="inline"/>    </p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md44"></a>
DC Power Inputs</h3>
<p>The onboard Teensy 4.1 and most IO gets power from the USB connector on the Teensy itself. A 5.5mm OD / 2.1mm ID barrel connector accepts 12V-24V power that is routed to the stepper drivers.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md45"></a>
Stepdance Ports</h3>
<ul>
<li>four independent stepdance input ports A-&gt;D.</li>
<li>stepdance output ports A-&gt;D are connected to stepper driver sockets</li>
<li>additionally, output port D is mirrored to a standard stepdance TRRS connector.</li>
</ul>
<p>We discuss stepdance ports in detail later in this document.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md46"></a>
Display and Control Knob Mounting</h3>
<p>Board-mounted standoffs are provided for a <a href="https://www.sparkfun.com/sparkfun-qwiic-oled-display-0-91-in-128x32-lcd-24606.html">Sparkfun QWIIC OLED</a> and a <a href="https://www.sparkfun.com/sparkfun-qwiic-twist-rgb-rotary-encoder-breakout.html">Sparkfun QWIIC Twist knob</a>.</p>
<p>Although three standoffs are shown for the OLED, <b>only two should be installed on the PCB</b>. For an old-style OLED display, these are the left and right-most standoffs. For a new-style OLED, these are the top row of standoffs.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md47"></a>
Microcontroller</h3>
<p>The Stepdance driver module uses a Teensy 4.1, which is based off the IMXRT1062 (32-bit, 600MHz). The pinout we use is shown below: <img src="module_driver_teensy.png" alt="" class="inline"/>    </p>
<p>Notes on pin selection:</p>
<ul>
<li>stepdance outputs A-D use FlexIO</li>
<li>stepdance inputs A-D use FlexPMW</li>
<li>quadrature inputs use the QuadEncoder library</li>
<li>I2C0 is connected to QWIIC0</li>
<li>I2C1 is connected to QWIIC1, and also exposes TX4/RX4</li>
<li>output ref pins are analog inputs that allow the MCU to read the current setting on the drivers. Eventually we'll use this to help guide the user in setting the current.</li>
<li>output enable pins individually enable each driver</li>
<li>"LIM" are limit switch inputs for each output port.</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md48"></a>
Dimensions</h3>
<ul>
<li>Board dimensions are 5.5" x 4.0"</li>
<li>Four 3.5mm ID mounting holes are on 5.1" x 3.6" centers.</li>
<li>Standoffs of up to 6.3MM / 0.25" OD may be used.
- The corners are radiused at R0.15" </li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md49"></a>
Basic Module v1.0</h2>
<p><img src="module_basic.png" alt="" class="inline"/>    </p>
<p>This is a stripped-down version of the Driver Module. It has:</p>
<ul>
<li>2 encoder ports</li>
<li>4 analog/digital inputs A1-&gt;A4, which also can be digital outputs</li>
<li>2 digital inputs/outputs D1-&gt;D2</li>
<li>2 QWIIC connectors</li>
<li>1 stepdance input port</li>
<li>1 stepdance output port</li>
</ul>
<p>Pinouts for all connectors are the same as the driver module.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md50"></a>
Microcontroller</h3>
<p>The stepdance basic module can utilize either a Teensy 4.1 or a Teensy 4.0. The only difference is cost, and the 4.1 has an onboard SD card.</p>
<p><b>The pinout is different from the driver module</b>, and is shown below: <img src="module_basic_teensy.png" alt="" class="inline"/>    </p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md51"></a>
Dimensions</h3>
<ul>
<li>Board dimensions are 3.0" x 3.0"</li>
<li>Four 3.5mm ID mounting holes are on 2.6" x 2.6" centers.</li>
<li>Standoffs of up to 6.3MM / 0.25" OD may be used.
- The corners are radiused at R0.15"</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md52"></a>
Hobby Servo Driver</h2>
<p><img src="servo_stepper.png" alt="" class="inline"/>    </p>
<p>The Hobby Servo Driver is a drop-in replacement for the BIGTREETECH TMC2209 stepper drivers, and provides a step/direction interface to controlling a standard hobby servo.</p>
<p>An ATTiny84 accumulates step/dir inputs and outputs a standard pulse-width modulated signal. The timing of this signal is shown below:</p>
<div class="image">
<img src="rc_stepper_timing.png" alt=""/>
</div>
    <p>The attiny84 firmware is located in the repository <a href="/rcstepmodule/">here</a>.</p>
<p>Currently, the firmware is configured such that the servo starts in the neutral position, and 500 input steps in either direction results in full-scale motion of 90 degrees. This can of course be configured differently. Additionally, two adjustment parameters are provided (units are nominally in microseconds) to tweak the pulse width and time between pulse outputs. This is to adjust for inconsistencies in the onboard RC clock source.</p>
<p>The relevant lines are these:</p>
<div class="fragment"><div class="line">// ---- SETTINGS ----</div>
<div class="line">#define PULSE_PERIOD_US 24000 //24ms pulse period</div>
<div class="line">#define PULSE_PERIOD_OFFSET 850 //adjustment on time between pulses</div>
<div class="line">#define PULSE_WIDTH_OFFSET 40 //adjustment to pulse width</div>
<div class="line"> </div>
<div class="line">#define SERVO_TOP_LIMIT_STEPS 500 // +/- 500 steps is full-range, if 1 STEP == 1uS of pulse width</div>
<div class="line">#define SERVO_BOTTOM_LIMIT_STEPS -500</div>
<div class="line">#define SERVO_MIDPOINT_PULSE_WIDTH_US 1500</div>
</div><!-- fragment --><hr  />
 <h1 class="doxsection"><a class="anchor" id="autotoc_md53"></a>
Stepdance Ports</h1>
<p><img src="stepdance_hookup.png" alt="" class="inline"/>    </p>
<p>A key feature of Stepdance is that modules can be chained together by connecting the output port of one module to the input port of another. This allows modules to transmit what we call <em>motion streams</em> between modules, which are real-time multi-axis signals carrying motion information.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md54"></a>
Electrical</h2>
<p>We use standard tip-ring-ring-sleeve (TRRS) audio cables to carry these motion streams. Electrically, the TRRS connector has the following pinout: <img src="trrs_pinout.png" alt="" class="inline"/>    </p>
<p>Motion streams are carried by a step/direction signalling scheme, which is what's commonly used to control stepper drivers. <b>Signals are at 5V.</b> If you aren't familiar with step/direction, it works like this: <img src="step_dir_basics.png" alt="" class="inline"/>    </p>
<p>A unit of motion (a "step") is transmitted whenever the STEP line is pulsed HIGH. If the DIR line is HIGH when this pulse occurs, a FORWARD step is indicated. If DIR is LOW when the pulse occurs, then the a REVERSE step is indicated.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md55"></a>
Signals: Axis-Encoded Step Pulses</h2>
<p>In stepdance, we refer to these STEP pulses as <em>signals</em>, and use their duration to indicate motion in one of six axes:</p>
<div class="image">
<img src="stepdance_signals.png" alt=""/>
</div>
    <p>The encoding is as follows: </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Axis  </th><th class="markdownTableHeadNone">STEP Pulse Duration  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">X  </td><td class="markdownTableBodyNone">2us  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Y  </td><td class="markdownTableBodyNone">3us  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">R  </td><td class="markdownTableBodyNone">4us  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">θ  </td><td class="markdownTableBodyNone">5us  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Z  </td><td class="markdownTableBodyNone">6us  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">E  </td><td class="markdownTableBodyNone">7us  </td></tr>
</table>
<p>A few notes:</p>
<ul>
<li>R and θ signals support polar positioning systems</li>
<li>This scheme trades simplicity for robustness; electrical impedance can stretch out these signals. One way to think of this is as a 1MHz serial stream, where "X" is two high bits, "Y" is three, etc...</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md56"></a>
Frames: Multi-Axis Synchronous Motion</h2>
<p>This scheme doesn't care the order of pulses, or the maximum time between them. The stepdance library is implemented such that a particular signal only occurs at most <em>once</em> within a <em>frame</em>, as shown below:</p>
<div class="image">
<img src="stepdance_frames.png" alt=""/>
</div>
    <p>Each frame is 40us long, of which 32us is available for signals. A 2us inter-signal gap is imposed. It is during this gap that the direction signal changes state. In the diagram above, the four longest signals (R, θ, Z, and E) are being transmitted within a single frame. In this way, the stepdance frame can support 4 axes of simultaneous motion.</p>
<p>IMPORTANT NOTES:</p>
<ul>
<li>Although we use the convention of XYRθZE to name signals based on their duration, it is up to the system designer to assign these signals to particular axes of their machine.</li>
<li><b>Stepdance modules read the DIR line at the falling edge of the STEP pulse.</b> In this way we differ from stepper drivers, which read at the rising edge of STEP. We do this to improve performance by only needing to fire an interrupt once per pulse when reading an incoming signal, but has implications for compatibility with non-stepdance signalling sources. Future work will introduce alternative input modes to restore this compatibility.</li>
<li>Stepdance can be configured to output frames at higher frequencies, with corresponding limits to the number of signals that fit in a frame. See <a class="el" href="highspeed.html">High-Speed Frame Configuration</a> for configuration concepts.</li>
</ul>
<hr  />
 <h1 class="doxsection"><a class="anchor" id="autotoc_md57"></a>
Examples</h1>
<p>Here we provide some example projects based around an AxiDraw pen plotter, which are aimed at introducing the functionality of Stepdance and library usage. These examples build on each other in the order they are listed.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md58"></a>
"Step-A-Sketch" (Etch-A-Sketch)</h2>
<p><img src="step-a-sketch_teaser.png" alt="" class="inline"/>    </p>
<p>This example uses two encoders to control a pen plotter (e.g. an AxiDraw) in realtime, a la etch-a-sketch. One knob is mapped to the X axis, and the other to the Y axis. You will learn how to:</p>
<ul>
<li>configure outputs ports, in this case to control stepper motor drivers</li>
<li>create "channels" that each generate output stream components for individual axes of motion.</li>
<li>use kinematic modules to convert between cartesian XY space and machine motor space.</li>
<li>read position values from encoders, and use them to drive output channels.</li>
</ul>
<p>Read the full <a class="el" href="stepasketch.html">Step-A-Sketch Example</a> example page.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md59"></a>
Axidraw "EBB" Controller Emulator</h2>
<p><img src="axidraw_ebb_teaser.png" alt="" class="inline"/>    </p>
<p>In this example, we drive the Axidraw from Inkscape to plot an SVG file. This is accomplished with a Stepdance Interface module that emulates the Axidraw EBB control board, for which an inkscape plugin has been developed. We will build on the Step-a-Sketch example code, that provides real-time jog dials for positioning the pen's starting position. We additionally provide a hardware knob to control the drawing speed in real-time. You will learn how to:</p>
<ul>
<li>Use Interfaces to accept pre-planned motion commands in standard formats.</li>
<li>Use Interpolators to execute pre-planned motion commands as motion streams.</li>
<li>Read analog inputs (e.g. from potentiometers) via the analog-to-digital converter, and use it to adjust parameters of software modules (e.g. the speed of the interpolator).</li>
</ul>
<p>Read the full <a class="el" href="ebb.html">Axidraw EBB Controller Emulator Example</a> example page. </p><hr  />
 </div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
