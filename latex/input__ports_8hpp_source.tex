\doxysection{input\+\_\+ports.\+hpp}
\hypertarget{input__ports_8hpp_source}{}\label{input__ports_8hpp_source}\index{lib/input\_ports.hpp@{lib/input\_ports.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#include\ <sys/\_stdint.h>}}
\DoxyCodeLine{00002\ \textcolor{comment}{/*}}
\DoxyCodeLine{00003\ \textcolor{comment}{Input\ Ports\ Module\ of\ the\ StepDance\ Control\ System}}
\DoxyCodeLine{00004\ \textcolor{comment}{}}
\DoxyCodeLine{00005\ \textcolor{comment}{This\ module\ is\ responsible\ for\ reading\ input\ streams\ on\ the\ input\ ports,\ and\ directing\ them\ to}}
\DoxyCodeLine{00006\ \textcolor{comment}{specific\ channels.}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{[More\ Details\ to\ be\ Added]}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{A\ part\ of\ the\ Mixing\ Metaphors\ Project}}
\DoxyCodeLine{00011\ \textcolor{comment}{(c)\ 2025\ Ilan\ Moyer,\ Jennifer\ Jacobs,\ Devon\ Frost}}
\DoxyCodeLine{00012\ \textcolor{comment}{*/}}
\DoxyCodeLine{00013\ \textcolor{preprocessor}{\#include\ "{}channels.hpp"{}}}
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ "{}imxrt.h"{}}}
\DoxyCodeLine{00015\ }
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#ifndef\ input\_ports\_h\ }\textcolor{comment}{//prevent\ importing\ twice}}
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#define\ input\_ports\_h}}
\DoxyCodeLine{00018\ }
\DoxyCodeLine{00019\ \textcolor{preprocessor}{\#define\ NUM\_AVAILABLE\_INPUT\_PORTS\ \ \ \ 6\ }\textcolor{comment}{//four\ in\ new\ PCB\ designs,\ plus\ one\ legacy\ port\ in\ old\ PCBs.\ If\ changed,\ must\ adjust\ ISR\ functions\ in\ input\_port}}
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#define\ INPUT\_A\ \ \ \ \ \ \ \ \ 0}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#define\ INPUT\_B\ \ \ \ \ \ \ \ \ 1}}
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#define\ INPUT\_C\ \ \ \ \ \ \ \ \ 2}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#define\ INPUT\_D\ \ \ \ \ \ \ \ \ 3}}
\DoxyCodeLine{00024\ \textcolor{preprocessor}{\#define\ INPUT\_B\_LEGACY\ \ 4\ }\textcolor{comment}{//\ Port\ B\ on\ legacy\ DPW\ Modules}}
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#define\ INPUT\_C\_LEGACY\ \ 5\ }\textcolor{comment}{//\ PORT\ C\ on\ legacy\ DPW\ Modules}}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{preprocessor}{\#define\ FLEXPWM\_CHANNEL\_X\ \ \ 0}}
\DoxyCodeLine{00028\ \textcolor{preprocessor}{\#define\ FLEXPWM\_CHANNEL\_A\ \ \ 1}}
\DoxyCodeLine{00029\ \textcolor{preprocessor}{\#define\ FLEXPWM\_CHANNEL\_B\ \ \ 2}}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#define\ FLEXPWM\_CLOCK\_MHZ\ 150}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#define\ SIGNAL\_MIN\_WIDTH\_US\ 2\ }\textcolor{comment}{//standard\ input\ format}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00039\ \textcolor{keyword}{struct\ }input\_port\_info\_struct\{\ \textcolor{comment}{//we\ use\ this\ structure\ to\ store\ hardware-\/specific\ information\ for\ each\ available\ port}}
\DoxyCodeLine{00040\ \ \ \ \ \textcolor{comment}{//\ Physical\ IO}}
\DoxyCodeLine{00041\ \ \ uint8\_t\ STEP\_TEENSY\_PIN;\ \textcolor{comment}{//TEENSY\ Pin\ \#s}}
\DoxyCodeLine{00042\ \ \ uint8\_t\ DIR\_TEENSY\_PIN;}
\DoxyCodeLine{00043\ }
\DoxyCodeLine{00044\ \ \ \textcolor{comment}{//\ FlexPWM\ Module\ Setup}}
\DoxyCodeLine{00045\ \ \ uint8\_t\ FLEXPWM\_NUM;\ \textcolor{comment}{//FlexPWM\ number,\ e.g.\ 1\ for\ FlexPWM1}}
\DoxyCodeLine{00046\ \ \ IMXRT\_FLEXPWM\_t\ *FLEXPWM;\ \textcolor{comment}{//\ pointer\ to\ FlexPWM\ Module}}
\DoxyCodeLine{00047\ \ \ uint8\_t\ SUBMODULE;\ \textcolor{comment}{//\ submodule\ \#\ 0-\/3}}
\DoxyCodeLine{00048\ \ \ uint8\_t\ FLEXPWM\_CHANNEL;\ \textcolor{comment}{//\ submodule\ channel,\ use\ definitions\ like\ FLEXPWM\_CHANNEL\_X}}
\DoxyCodeLine{00049\ \ \ uint8\_t\ STEP\_PIN\_MUX;\ \textcolor{comment}{//pad\ mux\ value\ for\ flexpwm\ module}}
\DoxyCodeLine{00050\ \ \ \textcolor{keyword}{volatile}\ uint32\_t\ *SELECT\_INPUT\_REGISTER;\ \textcolor{comment}{//pwm\ pad\ select\ register,\ for\ pins\ that\ can\ connect\ to\ multiple\ pads}}
\DoxyCodeLine{00051\ \ \ uint32\_t\ SELECT\_REGISTER\_VALUE;\ \textcolor{comment}{//appropriate\ pad\ select\ register\ value}}
\DoxyCodeLine{00052\ \ \ uint8\_t\ IRQ;\ \textcolor{comment}{//\ the\ IRQ\ number\ for\ the\ interrupt\ source}}
\DoxyCodeLine{00053\ \ \ void\ (*STATIC\_ISR)();\ \textcolor{comment}{//\ interrupt\ service\ routine.\ This\ needs\ to\ be\ a\ static\ function.\ We\ do\ some\ acrobatics\ to\ be\ able\ to\ call\ class\ methods\ as\ ISRs.}}
\DoxyCodeLine{00054\ \};}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00058\ }
\DoxyCodeLine{00064\ \textcolor{keyword}{class\ }\mbox{\hyperlink{class_input_port_af2431071e069bf97869b474ae313406b}{InputPort}}\ :\ \textcolor{keyword}{public}\ Plugin\{}
\DoxyCodeLine{00065\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00074\ \ \ \ \ \mbox{\hyperlink{class_input_port_af2431071e069bf97869b474ae313406b}{InputPort}}();}
\DoxyCodeLine{00079\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_input_port_a7bec13041ef7d76fbcb3f4126300270a}{begin}}(uint8\_t\ port\_number);}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_input_port_a0797c12815fab1d042c5eee79760d8f5}{enable\_all\_signals}}();}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_input_port_a9e0eaea831a5cc11cb1090b0f2ea3374}{disable\_all\_signals}}();}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_input_port_a763067922fd8ccc47ecf82b560e2ad56}{enable\_signal}}(uint8\_t\ signal\_index);}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_input_port_a7f921423eb6da67a964967083d163345}{disable\_signal}}(uint8\_t\ signal\_index);\ \ \ \ }
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{class_input_port_a36b4299d3b36c3a2f5404be75f477f48}{set\_ratio}}(\textcolor{keywordtype}{float}\ output\_units,\ \textcolor{keywordtype}{float}\ input\_units\ =\ 1.0);\ }
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{keywordtype}{void}\ enroll(RPC\ *rpc,\ \textcolor{keyword}{const}\ String\&\ instance\_name);}
\DoxyCodeLine{00109\ }
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keyword}{volatile}\ uint32\_t\ input\_interrupt\_cycles;\ \textcolor{comment}{//measures\ the\ number\ of\ cycles\ spent\ in\ each\ input\ interrupt\ routine.}}
\DoxyCodeLine{00112\ \ \ \ \ }
\DoxyCodeLine{00113\ \ \ \ \ \textcolor{comment}{//\ BlockPorts}}
\DoxyCodeLine{00122\ \ \ \ \ BlockPort\ \mbox{\hyperlink{class_input_port_a7352accb51d331f3ec1f827c0af6fc24}{output\_x}};\ \textcolor{comment}{//\ 2us\ signal}}
\DoxyCodeLine{00126\ \ \ \ \ BlockPort\ \mbox{\hyperlink{class_input_port_a0b2ad48f40bfff29bc53dd55f84a34fb}{output\_y}};\ \textcolor{comment}{//\ 3us\ signal}}
\DoxyCodeLine{00130\ \ \ \ \ BlockPort\ \mbox{\hyperlink{class_input_port_afed004f3067384be0634ecc591c1870a}{output\_r}};\ \textcolor{comment}{//\ 4us\ signal}}
\DoxyCodeLine{00134\ \ \ \ \ BlockPort\ \mbox{\hyperlink{class_input_port_a7e65195177953fb499b7c6fdc88f74ba}{output\_t}};\ \textcolor{comment}{//\ 5us\ signal}}
\DoxyCodeLine{00138\ \ \ \ \ BlockPort\ \mbox{\hyperlink{class_input_port_ac9cf91a3af212ae8ae12d44f087ad487}{output\_z}};\ \textcolor{comment}{//\ 6us\ signal}}
\DoxyCodeLine{00142\ \ \ \ \ BlockPort\ \mbox{\hyperlink{class_input_port_ae7d83e7c3c03b8edffb9f21f1caf113f}{output\_e}};\ \textcolor{comment}{//\ 7us\ signal}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \ \ }
\DoxyCodeLine{00145\ }
\DoxyCodeLine{00146\ }
\DoxyCodeLine{00147\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00148\ \ \ \ \ \textcolor{comment}{//\ Configuration\ Parameters}}
\DoxyCodeLine{00149\ \ \ \ \ uint8\_t\ port\_number;\ \textcolor{comment}{//the\ output\ port\ ID\ number}}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keyword}{struct\ }input\_port\_info\_struct\ port\_info[];\ \textcolor{comment}{//stores\ setup\ information\ for\ all\ four\ input\ ports}}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keyword}{static}\ \mbox{\hyperlink{class_input_port_af2431071e069bf97869b474ae313406b}{InputPort}}\ *indexed\_input\_ports[NUM\_AVAILABLE\_INPUT\_PORTS];\ \textcolor{comment}{//keeps\ pointers\ to\ all\ active\ input\ ports,\ indexed\ by\ their\ port\ number.\ Only\ used\ for\ ISR\ routines.}}
\DoxyCodeLine{00152\ }
\DoxyCodeLine{00153\ \ \ \ \ IMXRT\_FLEXPWM\_t\ *FLEXPWM;}
\DoxyCodeLine{00154\ \ \ \ \ uint8\_t\ SUBMODULE;}
\DoxyCodeLine{00155\ \ \ \ \ uint8\_t\ SUBMODULE\_BIT;}
\DoxyCodeLine{00156\ \ \ \ \ uint8\_t\ FLEXPWM\_CHANNEL;}
\DoxyCodeLine{00157\ \ \ \ \ \textcolor{comment}{//\ The\ following\ variables\ are\ used\ within\ the\ pulse\ detection\ and\ routing\ ISR,\ but\ we\ declare\ them\ here\ to\ save\ ISR\ run\ time.}}
\DoxyCodeLine{00158\ \ \ \ \ \textcolor{keyword}{volatile}\ uint16\_t\ last\_pulse\_width\_count;\ \textcolor{comment}{//important\ that\ this\ is\ UINT16\_T\ to\ calculate\ rollover\ correctly.}}
\DoxyCodeLine{00159\ }
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{comment}{//\ State\ Parameters}}
\DoxyCodeLine{00161\ \ \ \ \ BlockPort\ *signal\_BlockPort\_targets[NUM\_SIGNALS]\ =\ \{\&\mbox{\hyperlink{class_input_port_a7352accb51d331f3ec1f827c0af6fc24}{output\_x}},\ \&\mbox{\hyperlink{class_input_port_a0b2ad48f40bfff29bc53dd55f84a34fb}{output\_y}},\ \&\mbox{\hyperlink{class_input_port_afed004f3067384be0634ecc591c1870a}{output\_r}},\ \&\mbox{\hyperlink{class_input_port_a7e65195177953fb499b7c6fdc88f74ba}{output\_t}},\ \&\mbox{\hyperlink{class_input_port_ac9cf91a3af212ae8ae12d44f087ad487}{output\_z}},\ \&\mbox{\hyperlink{class_input_port_ae7d83e7c3c03b8edffb9f21f1caf113f}{output\_e}}\};\ \textcolor{comment}{//pointers\ to\ BlockPorts,\ indexed\ by\ signal\ number}}
\DoxyCodeLine{00162\ \ \ \ \ \textcolor{keywordtype}{bool}\ signal\_enable\_flags[NUM\_SIGNALS]\ =\ \{\textcolor{keyword}{true},\ \textcolor{keyword}{true},\ \textcolor{keyword}{true}\};}
\DoxyCodeLine{00163\ }
\DoxyCodeLine{00164\ \ \ \ \ \textcolor{comment}{//\ Private\ Methods}}
\DoxyCodeLine{00165\ \ \ \ \ \textcolor{keywordtype}{void}\ isr();\ \textcolor{comment}{//this\ is\ the\ actual\ ISR\ function}}
\DoxyCodeLine{00166\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ input\_A\_isr();}
\DoxyCodeLine{00167\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ input\_B\_isr();}
\DoxyCodeLine{00168\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ input\_C\_isr();}
\DoxyCodeLine{00169\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ input\_D\_isr();}
\DoxyCodeLine{00170\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ input\_B\_legacy\_isr();}
\DoxyCodeLine{00171\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ input\_C\_legacy\_isr();}
\DoxyCodeLine{00172\ }
\DoxyCodeLine{00173\ \ \ \ \ \ }
\DoxyCodeLine{00174\ \ \ \ \ \textcolor{comment}{//\ Input\ Position\ Registers}}
\DoxyCodeLine{00175\ \ \ \ \ DecimalPosition\ position\_x;}
\DoxyCodeLine{00176\ \ \ \ \ DecimalPosition\ position\_y;}
\DoxyCodeLine{00177\ \ \ \ \ DecimalPosition\ position\_r;}
\DoxyCodeLine{00178\ \ \ \ \ DecimalPosition\ position\_t;}
\DoxyCodeLine{00179\ \ \ \ \ DecimalPosition\ position\_z;}
\DoxyCodeLine{00180\ \ \ \ \ DecimalPosition\ position\_e;}
\DoxyCodeLine{00181\ }
\DoxyCodeLine{00182\ \ \ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00187\ \ \ \ \ \textcolor{keywordtype}{void}\ run();}
\DoxyCodeLine{00189\ \};}
\DoxyCodeLine{00190\ }
\DoxyCodeLine{00191\ }
\DoxyCodeLine{00192\ }
\DoxyCodeLine{00193\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
