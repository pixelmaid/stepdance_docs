\doxysection{analog\+\_\+in.\+hpp}
\hypertarget{analog__in_8hpp_source}{}\label{analog__in_8hpp_source}\index{lib/analog\_in.hpp@{lib/analog\_in.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#include\ "{}arm\_math.h"{}}}
\DoxyCodeLine{00002\ \textcolor{preprocessor}{\#include\ <sys/\_stdint.h>}}
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ <Arduino.h>}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}core.hpp"{}}}
\DoxyCodeLine{00005\ \textcolor{comment}{/*}}
\DoxyCodeLine{00006\ \textcolor{comment}{Analog\ Input\ Module\ of\ the\ StepDance\ Control\ System}}
\DoxyCodeLine{00007\ \textcolor{comment}{}}
\DoxyCodeLine{00008\ \textcolor{comment}{This\ module\ is\ responsible\ for\ reading\ analog\ input\ values\ in\ the\ background,\ and\ setting\ target\ parameters.}}
\DoxyCodeLine{00009\ \textcolor{comment}{}}
\DoxyCodeLine{00010\ \textcolor{comment}{[More\ Details\ to\ be\ Added]}}
\DoxyCodeLine{00011\ \textcolor{comment}{}}
\DoxyCodeLine{00012\ \textcolor{comment}{A\ part\ of\ the\ Mixing\ Metaphors\ Project}}
\DoxyCodeLine{00013\ \textcolor{comment}{(c)\ 2025\ Ilan\ Moyer,\ Jennifer\ Jacobs,\ Devon\ Frost}}
\DoxyCodeLine{00014\ \textcolor{comment}{}}
\DoxyCodeLine{00015\ \textcolor{comment}{*/}}
\DoxyCodeLine{00016\ }
\DoxyCodeLine{00017\ \textcolor{preprocessor}{\#ifndef\ analog\_in\_h\ }\textcolor{comment}{//prevent\ importing\ twice}}
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#define\ analog\_in\_h}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#define\ ADC\_MODULE\_1\ \ \ \ 0}}
\DoxyCodeLine{00021\ \textcolor{preprocessor}{\#define\ ADC\_MODULE\_2\ \ \ \ 1}}
\DoxyCodeLine{00022\ }
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#define\ ADC\_NONE\ 255\ }\textcolor{comment}{//used\ to\ flag\ modules\ and\ channels\ when\ pin\ does\ not\ map\ to\ an\ ADC}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{preprocessor}{\#define\ NUM\_ADC\_MODULES\ \ \ \ \ 2}}
\DoxyCodeLine{00026\ \textcolor{preprocessor}{\#define\ MAX\_NUM\_ADC\_INPUTS\ \ 16\ \ }\textcolor{comment}{//per\ module}}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \textcolor{comment}{//\ -\/-\/-\/ADC\ SETTINGS-\/-\/-\/}}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{comment}{//\ AVERAGING}}
\DoxyCodeLine{00031\ \textcolor{preprocessor}{\#define\ ANALOG\_AVERAGING\_1\ \ \ \ -\/1\ }\textcolor{comment}{//AVGE\ =\ 0}}
\DoxyCodeLine{00032\ \textcolor{preprocessor}{\#define\ ANALOG\_AVERAGING\_4\ \ \ \ 0\ }\textcolor{comment}{//AVGE\ =\ 1,\ corresponds\ to\ settings\ of\ AVGS}}
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#define\ ANALOG\_AVERAGING\_8\ \ \ \ 1}}
\DoxyCodeLine{00034\ \textcolor{preprocessor}{\#define\ ANALOG\_AVERAGING\_16\ \ \ 2}}
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#define\ ANALOG\_AVERAGING\_32\ \ \ 3}}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \textcolor{comment}{//\ SAMPLE\ RESOLUTION}}
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#define\ ANALOG\_RESOLUTION\_8\_BIT\ \ \ 0}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#define\ ANALOG\_RESOLUTION\_10\_BIT\ \ 1}}
\DoxyCodeLine{00040\ \textcolor{preprocessor}{\#define\ ANALOG\_RESOLUTION\_12\_BIT\ \ 2}}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \textcolor{comment}{//\ CLOCK\ SPEED}}
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#define\ ANALOG\_CLOCK\_75MHZ\_DIV\_4\ \ \ \ \ 1}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#define\ ANALOG\_CLOCK\_75MHZ\_DIV\_8\ \ \ \ \ 2}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#define\ ANALOG\_CLOCK\_75MHZ\_DIV\_16\ \ \ \ 3}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \textcolor{comment}{//\ ENABLED}}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#define\ ANALOG\_INPUT\_DISABLED\ 0}}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#define\ ANALOG\_INPUT\_ENABLED\ \ 1}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \textcolor{comment}{//\ REFERENCE\ VOLTAGE}}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#define\ VREF\_3V3\ \ 3.3}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \textcolor{comment}{//\ DEADBAND\ STARTUP\ DELAY}}
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#define\ ANALOG\_DEADBAND\_STARTUP\_DELAY\_MS\ \ \ 20}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structanalog__pin__info__struct}{analog\_pin\_info\_struct}}\{\ \textcolor{comment}{//hardware\_specific\ }}
\DoxyCodeLine{00058\ \ \ \ \ \textcolor{comment}{//\ Physical\ IO}}
\DoxyCodeLine{00059\ \ \ uint8\_t\ TEENSY\_PIN;\ \textcolor{comment}{//TEENSY\ Pin\ \#s}}
\DoxyCodeLine{00060\ \ \ uint8\_t\ ADC\_MODULE;\ \textcolor{comment}{//Which\ ADC\ module\ to\ use\ with\ this\ pin\ (some\ pins\ only\ support\ a\ single\ module)}}
\DoxyCodeLine{00061\ \ \ uint8\_t\ ADC\_INPUT\_CHANNEL;\ \textcolor{comment}{//input\ number\ on\ the\ module}}
\DoxyCodeLine{00062\ \};}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \textcolor{keyword}{class\ }AnalogInput\{}
\DoxyCodeLine{00065\ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00066\ \ \ \ \ AnalogInput();}
\DoxyCodeLine{00067\ \ \ \ \ \textcolor{keywordtype}{void}\ begin(uint8\_t\ pin\_reference);}
\DoxyCodeLine{00068\ \ \ \ \ \textcolor{keywordtype}{void}\ calibrate();}
\DoxyCodeLine{00069\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_averaging(int8\_t\ averaging);}
\DoxyCodeLine{00070\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_resolution(int8\_t\ resolution);}
\DoxyCodeLine{00071\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_clock(int8\_t\ clock);}
\DoxyCodeLine{00072\ \ \ \ \ \textcolor{keywordtype}{void}\ map(ControlParameter\ *target\_parameter);}
\DoxyCodeLine{00073\ \ \ \ \ \textcolor{keywordtype}{void}\ map(DecimalPosition\ *target\_parameter);}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_callback(\textcolor{keywordtype}{void}\ (*callback\_function)());}
\DoxyCodeLine{00076\ \ \ \ \ \textcolor{keyword}{volatile}\ uint16\_t\ last\_value\_raw\ =\ 0;}
\DoxyCodeLine{00077\ \ \ \ \ void\ (*callback\_function)()\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00078\ \ \ \ \ ControlParameter\ *target\_control\_param\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00079\ \ \ \ \ DecimalPosition\ *target\_decimal\_pos\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{00080\ \ \ \ \ \textcolor{keyword}{static}\ AnalogInput\ *adc1\_inputs[MAX\_NUM\_ADC\_INPUTS];\ \textcolor{comment}{//keeps\ pointers\ to\ all\ instantiated\ analog\ inputs\ on\ the\ ADC1\ module}}
\DoxyCodeLine{00081\ \ \ \ \ \textcolor{keyword}{static}\ AnalogInput\ *adc2\_inputs[MAX\_NUM\_ADC\_INPUTS];}
\DoxyCodeLine{00082\ \ \ \ \ \textcolor{keyword}{static}\ uint8\_t\ module\_num\_inputs[NUM\_ADC\_MODULES];\ \textcolor{comment}{//tracks\ the\ number\ of\ instantiated\ analog\ inputs\ on\ the\ ADC\ module;\ indexed\ by\ ADC\ module}}
\DoxyCodeLine{00083\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{volatile}\ uint8\_t\ module\_current\_input\_index[NUM\_ADC\_MODULES];\ \textcolor{comment}{//current\ analog\ input}}
\DoxyCodeLine{00084\ \ \ \ \ \textcolor{keywordtype}{void}\ configure\_adc();\ \textcolor{comment}{//changes\ the\ ADC\ configuration\ to\ support\ this\ AnalogInput}}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keywordtype}{void}\ begin\_conversion();\ \textcolor{comment}{//begins\ a\ conversion\ on\ the\ ADC\ module}}
\DoxyCodeLine{00086\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_floor(ControlParameter\ output\_at\_floor);\ \textcolor{comment}{//sets\ the\ scaled\ output\ value\ at\ the\ floor}}
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_floor(ControlParameter\ output\_at\_floor,\ uint16\_t\ adc\_lower\_limit);\ \textcolor{comment}{//allows\ the\ lower\ limit\ to\ be\ adjusted.\ ADC\ values\ below\ this\ will\ output\ at\ the\ floor}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_ceiling(ControlParameter\ output\_at\_ceiling);}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_ceiling(ControlParameter\ output\_at\_ceiling,\ uint16\_t\ adc\_upper\_limit);}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_deadband\_here(ControlParameter\ output\_at\_deadband\ =\ 0,\ uint16\_t\ adc\_deadband\_width\ =\ 4);\ \textcolor{comment}{//sets\ the\ deadband\ to\ the\ current\ value.}}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_deadband(ControlParameter\ output\_at\_deadband,\ uint16\_t\ adc\_deadband\_center,\ uint16\_t\ adc\_deadband\_width\ =\ 4);}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{keywordtype}{void}\ invert();\ \textcolor{comment}{//inverts\ the\ output}}
\DoxyCodeLine{00093\ \ \ \ \ ControlParameter\ read();\ \textcolor{comment}{//returns\ the\ last\ read\ value,\ based\ on\ the\ internal\ conversion\ factor}}
\DoxyCodeLine{00094\ \ \ \ \ float32\_t\ full\_scale\_volts\ =\ VREF\_3V3;\ \textcolor{comment}{//we'll\ default\ to\ this\ for\ now,\ until\ we\ support\ changing\ the\ reference\ voltage.}}
\DoxyCodeLine{00095\ }
\DoxyCodeLine{00096\ \ \ \ \ float32\_t\ conversion\_slope\_1\ =\ 1;}
\DoxyCodeLine{00097\ \ \ \ \ float32\_t\ conversion\_intercept\_1\ =\ 0;}
\DoxyCodeLine{00098\ \ \ \ \ float32\_t\ conversion\_slope\_2\ =\ 1;}
\DoxyCodeLine{00099\ \ \ \ \ float32\_t\ conversion\_intercept\_2\ =\ 0;}
\DoxyCodeLine{00100\ \ \ \ \ uint16\_t\ adc\_deadband\_location\ =\ 0;}
\DoxyCodeLine{00101\ \ \ \ \ uint16\_t\ adc\_deadband\_width\ =\ 0;}
\DoxyCodeLine{00102\ \ \ \ \ uint16\_t\ adc\_deadband\_lower\ =\ 0;}
\DoxyCodeLine{00103\ \ \ \ \ uint16\_t\ adc\_deadband\_upper\ =\ 0;}
\DoxyCodeLine{00104\ }
\DoxyCodeLine{00105\ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{comment}{//\ Static\ Parameters\ and\ Methods}}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ uint16\_t\ max\_adc\_values[3];\ \textcolor{comment}{//8,\ 10,\ 12\ bit}}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keyword}{struct\ }\mbox{\hyperlink{structanalog__pin__info__struct}{analog\_pin\_info\_struct}}\ analog\_pin\_info[];\ \textcolor{comment}{//stores\ setup\ information\ for\ all\ analog\ inputs}}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{volatile}\ uint8\_t\ module\_calibrating[NUM\_ADC\_MODULES];\ \textcolor{comment}{//flag\ to\ indicate\ that\ ADC\ is\ currently\ calibrating}}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ adc1\_on\_interrupt();}
\DoxyCodeLine{00111\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ adc2\_on\_interrupt();}
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{keywordtype}{void}\ set\_slope\_intercept();\ \textcolor{comment}{//utility\ to\ set\ the\ slope\ and\ intercept\ values.}}
\DoxyCodeLine{00113\ \ \ \ \ }
\DoxyCodeLine{00114\ \ \ \ \ \textcolor{comment}{//\ Instance\ Parameters\ and\ Methods}}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{keywordtype}{void}\ initialize\_adc();\ \textcolor{comment}{//initializes\ ADC\ modules}}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{comment}{//\ Default\ Values}}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{comment}{//\ SFCAdder\ =\ 3,\ AverageNum\ =\ 32,\ BCT\ =\ 21,\ LST\ =\ 21\ -\/-\/>\ Total\ ADCLK\ per\ input\ =\ 1347}}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{comment}{//\ At\ CLK/16,\ this\ gives\ a\ total\ sample\ rate\ of\ 3480\ Hz,\ which\ would\ be\ the\ interrupt\ rate.}}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{comment}{//\ Spread\ across\ four\ analog\ inputs,\ this\ is\ \string~\ 870Hz.\ We'll\ turn\ off\ the\ VREF\ inputs\ when\ not\ actively\ reading\ them}}
\DoxyCodeLine{00120\ \ \ \ \ int8\_t\ averaging\ =\ ANALOG\_AVERAGING\_32;}
\DoxyCodeLine{00121\ \ \ \ \ int8\_t\ resolution\ =\ ANALOG\_RESOLUTION\_10\_BIT;}
\DoxyCodeLine{00122\ \ \ \ \ int8\_t\ clock\ =\ ANALOG\_CLOCK\_75MHZ\_DIV\_16;}
\DoxyCodeLine{00123\ \ \ \ \ int8\_t\ input\_enabled\ =\ ANALOG\_INPUT\_ENABLED;}
\DoxyCodeLine{00124\ \ \ \ \ uint8\_t\ adc\_module;}
\DoxyCodeLine{00125\ \ \ \ \ uint8\_t\ adc\_input\_channel;}
\DoxyCodeLine{00126\ \ \ \ \ uint8\_t\ teensy\_pin;}
\DoxyCodeLine{00127\ \ \ \ \ ControlParameter\ output\_at\_floor\ =\ 0;}
\DoxyCodeLine{00128\ \ \ \ \ ControlParameter\ output\_at\_deadband\ =\ 512;}
\DoxyCodeLine{00129\ \ \ \ \ ControlParameter\ output\_at\_ceiling\ =\ 1023;}
\DoxyCodeLine{00130\ \ \ \ \ uint16\_t\ adc\_lower\_limit\ =\ 0;}
\DoxyCodeLine{00131\ \ \ \ \ uint16\_t\ adc\_upper\_limit\ =\ 1023;\ \textcolor{comment}{//10\ bit}}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{keywordtype}{bool}\ deadband\_enabled\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \ \ \ \ int8\_t\ inversion\_multiplier\ =\ 1;\ \textcolor{comment}{//1\ for\ straight\ thru,\ -\/1\ for\ inverted}}
\DoxyCodeLine{00135\ \};}
\DoxyCodeLine{00136\ }
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
